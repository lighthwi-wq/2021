<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IDEA BRAIN • 2025 Compact (fixed)</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,300..700,0..1,-50..200" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">

  <style>
    :root {
      --font-family: 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
      --fs-12: .75rem; --fs-13: .8125rem; --fs-14: .875rem; --fs-16: 1rem; --fs-18: 1.125rem; --fs-22: 1.375rem; --fs-28: 1.75rem;
      --r-xs: 10px; --r-sm: 12px; --r-md: 14px; --r-lg: 16px; --r-xl: 20px;
      --sp-4: .25rem; --sp-6: .375rem; --sp-8: .5rem; --sp-10: .625rem; --sp-12: .75rem; --sp-14: .875rem; --sp-16: 1rem; --sp-20: 1.25rem; --sp-24: 1.5rem;
      --bg: #0b0b0c; --bg-elev: #121316; --text: #e5e7eb; --muted: #9aa3b2; --hairline: rgba(255,255,255,.06);
      --card: linear-gradient(180deg, rgba(24,26,31,.8), rgba(16,18,22,.8)); --glass: blur(18px);
      --accent-1:#6d79ff; --accent-2:#8a5cff; --accent-3:#f093fb; --accent-grad:linear-gradient(135deg,var(--accent-1),var(--accent-2) 55%,var(--accent-3));
      --shadow-sm:0 4px 14px rgba(0,0,0,.25); --shadow-md:0 10px 24px rgba(0,0,0,.28); --shadow-lg:0 18px 40px rgba(0,0,0,.32);
      --ctl-40:40px; --ctl-48:48px; --fab:56px; --ease:cubic-bezier(.4,0,.2,1); --dur-1:.18s; --dur-2:.28s; --dur-3:.44s;
    }
    html.light {
      --bg:#f8f9fb; --bg-elev:rgba(255,255,255,.9); --text:#1c212b; --muted:#697386; --hairline:rgba(0,0,0,.08);
      --card: linear-gradient(180deg, rgba(255,255,255,.98), rgba(248,249,252,.95));
    }
    @media (prefers-color-scheme: light) {
      :root:not(.light):not(.dark) {
        --bg:#f8f9fb; --bg-elev:rgba(255,255,255,.9); --text:#1c212b; --muted:#697386; --hairline:rgba(0,0,0,.08);
        --card: linear-gradient(180deg, rgba(255,255,255,.98), rgba(248,249,252,.95));
      }
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font:400 var(--fs-14)/1.55 var(--font-family);color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .material-symbols-rounded{font-variation-settings:'FILL' 1,'wght' 500,'GRAD' 0,'opsz' 24}

    header{position:sticky;top:0;z-index:50;backdrop-filter:var(--glass);background:color-mix(in srgb,var(--bg-elev) 88%,transparent);border-bottom:1px solid var(--hairline)}
    .wrap{max-width:1040px;margin:0 auto;padding:var(--sp-12) var(--sp-16)} .row{display:flex;align-items:center;justify-content:space-between;gap:var(--sp-10)}
    .brand{font-weight:900;letter-spacing:-.02em;line-height:1;font-size:clamp(1.1rem,2.2vw,1.35rem);background:var(--accent-grad);-webkit-background-clip:text;background-clip:text;color:transparent}
    .toolbar{display:flex;align-items:center;gap:var(--sp-10)}
    .icon-btn{width:var(--ctl-40);height:var(--ctl-40);display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--hairline);border-radius:var(--r-md);background:color-mix(in srgb,var(--bg-elev) 92%,transparent);box-shadow:var(--shadow-sm);transition:transform var(--dur-1) var(--ease),background var(--dur-1) var(--ease);cursor:pointer}
    .icon-btn:hover{transform:translateY(-1px)} .icon-btn:active{transform:translateY(0)}
    html.dark .icon-btn,html.dark .cal-btn{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.14);color:var(--text)}
    html.light .icon-btn,html.light .cal-btn{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.12);color:var(--text)}
    .icon-btn:focus-visible,.cal-btn:focus-visible,.vbtn:focus-visible,.btn:focus-visible{outline:3px solid color-mix(in srgb,var(--accent-1) 45%,transparent);outline-offset:2px}

    /* Search bar */
    .search{margin-top:var(--sp-10);display:block;position:relative}
    .search input{width:100%;height:var(--ctl-48);background:color-mix(in srgb,var(--bg-elev) 85%,transparent);border:1px solid var(--hairline);border-radius:var(--r-lg);padding:0 var(--sp-16);color:var(--text);outline:none;transition:box-shadow var(--dur-1) var(--ease),border-color var(--dur-1) var(--ease)}
    .search input:focus{box-shadow:0 0 0 4px color-mix(in srgb,var(--accent-1) 18%,transparent);border-color:color-mix(in srgb,var(--accent-1) 38%,var(--hairline))}
    .search-results{position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--card);border:1px solid var(--hairline);border-radius:14px;box-shadow:var(--shadow-md);display:none;max-height:50vh;overflow:auto}
    .search-item{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;cursor:pointer}
    .search-item:hover{background:color-mix(in srgb,var(--accent-1) 10%,transparent)}
    .search-empty{padding:1rem;color:var(--muted);font-size:var(--fs-13)} mark{background:transparent;color:inherit}

    .viewbar{display:flex;gap:var(--sp-6);margin:var(--sp-12) 0 var(--sp-16);padding:var(--sp-6);border-radius:var(--r-lg);background:color-mix(in srgb,var(--bg-elev) 85%,transparent);width:max-content}
    .vbtn{display:flex;align-items:center;gap:var(--sp-6);border:1px solid transparent;border-radius:var(--r-md);padding:var(--sp-8) var(--sp-12);font-weight:800;cursor:pointer;transition:background var(--dur-1) var(--ease),color var(--dur-1) var(--ease)}
    html.dark .vbtn{color:#ffffff;border-color:rgba(255,255,255,.24);background:rgba(255,255,255,.06)}
    html.light .vbtn{color:#2b303b;border-color:rgba(0,0,0,.12);background:rgba(0,0,0,.04)}
    html.dark .vbtn:hover{background:rgba(255,255,255,.12)} html.light .vbtn:hover{background:rgba(0,0,0,.06)}
    .vbtn.active{background:var(--accent-grad);color:#fff;border-color:transparent}

    main{max-width:1040px;margin:0 auto;padding:var(--sp-16);padding-bottom:6.5rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:var(--sp-16)}
    .list{display:flex;flex-direction:column;gap:var(--sp-16)}

    .card{background:var(--card);border:1px solid var(--hairline);border-radius:var(--r-xl);padding:var(--sp-16);box-shadow:var(--shadow-md);transition:transform var(--dur-2) var(--ease),box-shadow var(--dur-2) var(--ease);cursor:pointer}
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg)}
    .thumb{position:relative;overflow:hidden;border-radius:var(--r-lg);margin-bottom:var(--sp-12)} .thumb img{width:100%;height:200px;object-fit:cover;display:block}
    .title{font-size:var(--fs-18);font-weight:900;letter-spacing:-.02em;margin-bottom:var(--sp-10)}
    .preview{color:var(--muted);font-size:var(--fs-13);line-height:1.6;margin-bottom:var(--sp-12)}
    .meta{display:flex;gap:var(--sp-14);color:var(--muted);font-size:var(--fs-12);font-weight:600}

    .tags{display:flex;flex-wrap:wrap;gap:var(--sp-8);margin-bottom:var(--sp-12)}
    .tag{display:inline-flex;align-items:center;gap:var(--sp-6);padding:var(--sp-6) var(--sp-10);border-radius:var(--r-sm);border:1px solid color-mix(in srgb,var(--accent-1) 34%,var(--hairline));background:color-mix(in srgb,var(--accent-1) 10%,transparent);color:color-mix(in srgb,var(--accent-1) 85%,white);font-weight:700;font-size:var(--fs-12)}

    .cal-card{background:var(--card);border:1px solid var(--hairline);border-radius:var(--r-xl);padding:var(--sp-16)}
    .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--sp-14)}
    .cal-title{font-size:var(--fs-18);font-weight:900;letter-spacing:-.02em}
    .cal-btn{width:var(--ctl-40);height:var(--ctl-40);border-radius:var(--r-md);border:1px solid var(--hairline);background:transparent;color:var(--muted);cursor:pointer}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:var(--sp-8)}
    .cal-dow{text-align:center;font-weight:700;font-size:var(--fs-12);color:var(--muted);padding:var(--sp-8)}
    .cal-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:var(--r-sm);cursor:pointer;font-weight:700;transition:transform var(--dur-1) var(--ease),background var(--dur-1) var(--ease)}
    .cal-day:hover{transform:scale(1.05);background:color-mix(in srgb,var(--accent-1) 10%,transparent)}
    .has-idea{background:var(--accent-grad);color:#fff}

    .empty{text-align:center;padding:4.5rem 1rem;color:var(--muted)} .empty .ico{font-size:3.75rem;background:var(--accent-grad);-webkit-background-clip:text;background-clip:text;color:transparent}
    .empty h3{font-size:var(--fs-18);color:var(--text);margin:var(--sp-10) 0 var(--sp-8)}

    .fab{position:fixed;right:1.25rem;bottom:1.25rem;width:var(--fab);height:var(--fab);border-radius:18px;background:var(--accent-grad);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow-lg);cursor:pointer;transition:transform var(--dur-2) var(--ease),box-shadow var(--dur-2) var(--ease);border:none}
    .fab:hover{transform:translateY(-2px) scale(1.04)}

    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:var(--sp-16);z-index:1000}
    .modal{width:100%;max-width:760px;background:var(--card);border:1px solid var(--hairline);border-radius:22px;box-shadow:var(--shadow-lg);overflow:hidden}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:var(--sp-14) var(--sp-16);border-bottom:1px solid var(--hairline)}
    .modal-title{font-size:var(--fs-18);font-weight:900;letter-spacing:-.02em}
    .modal-body{padding:var(--sp-16)}
    .label{display:block;margin-bottom:var(--sp-8);font-weight:800;font-size:var(--fs-12);color:var(--muted)}
    .input,.drop{width:100%;min-height:var(--ctl-48);border-radius:var(--r-lg);padding:0 var(--sp-14);background:color-mix(in srgb,var(--bg-elev) 85%,transparent);border:1px solid var(--hairline);color:var(--text);outline:none;transition:box-shadow var(--dur-1) var(--ease),border-color var(--dur-1) var(--ease)}
    .input:focus,.drop:focus{box-shadow:0 0 0 4px color-mix(in srgb,var(--accent-1) 16%,transparent);border-color:color-mix(in srgb,var(--accent-1) 32%,var(--hairline))}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--sp-6);padding:var(--sp-10) var(--sp-14);border-radius:var(--r-md);font-weight:800;cursor:pointer;border:1px solid transparent}
    .btn-primary{background:var(--accent-grad);color:#fff;box-shadow:var(--shadow-sm)} .btn-ghost{background:transparent;color:var(--muted);border-color:var(--hairline)}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}

    html.dark .modal{border-color:rgba(255,255,255,.7)} html.dark .modal-head{border-bottom-color:rgba(255,255,255,.4)}

    #editor{min-height:260px}
    .ql-toolbar.ql-snow{border:none !important;border-bottom:1px solid var(--hairline) !important;border-radius:var(--r-md) var(--r-md) 0 0 !important;background:color-mix(in srgb,var(--bg-elev) 92%,transparent) !important;padding:var(--sp-8) !important}
    .ql-container.ql-snow{border:none !important;border-radius:0 0 var(--r-md) var(--r-md) !important;background:color-mix(in srgb,var(--bg-elev) 95%,transparent) !important}
    .ql-editor{font-family:var(--font-family) !important;font-size:var(--fs-14);line-height:1.6;color:var(--text)}

    @media (prefers-reduced-motion: reduce){*{animation:none !important;transition-duration:.01ms !important}}

    /* Splash */
    .splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:10000;overflow:hidden;background:linear-gradient(135deg,#5b2cff,#b06bff 60%,#f093fb);animation:fadeIn var(--dur-3) var(--ease)}
    .splash.hide{opacity:0;pointer-events:none;transition:opacity .5s var(--ease)}
    .splash::before,.splash::after{content:"";position:absolute;inset:-20%;background:radial-gradient(closest-side,rgba(255,255,255,.16),transparent 60%);filter:blur(30px);animation:orbit 12s linear infinite}
    .splash::after{animation-duration:16s;animation-direction:reverse}
    @keyframes orbit{from{transform:rotate(0)}to{transform:rotate(360deg)}} @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .splash-card{position:relative;background:transparent;border:none;border-radius:0;box-shadow:none;padding:0;text-align:center}
    .splash-bulb{display:block;font-size:100px;line-height:1;margin-bottom:10px;animation:pulseGlow 1.6s ease-in-out infinite}
    @keyframes pulseGlow{0%,100%{opacity:.9;transform:translateY(0) scale(1)}50%{opacity:1;transform:translateY(-2px) scale(1.04)}}
    .splash-logo{font-weight:900;font-size:var(--fs-28);letter-spacing:-.02em;color:#fff}
    .splash-sub{margin-top:6px;color:#f6edff;font-size:var(--fs-12);opacity:.9}
    .splash-sub::after{content:"";display:inline-block;width:1.8ch;animation:dotstep 1.2s steps(3,end) infinite}
    @keyframes dotstep{0%{content:""}33%{content:"."}66%{content:".."}100%{content:"..."}}

    /* Outline-only Material icon for splash */
    .ms-outline{color:transparent;-webkit-text-stroke:2px #ffffff;text-stroke:2px #ffffff;font-variation-settings:'FILL' 0,'wght' 600,'GRAD' 0,'opsz' 48}

    /* Skip button on splash */
    .skip-btn{margin-top:12px;padding:8px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.5);background:rgba(255,255,255,.12);color:#fff;font-weight:800;letter-spacing:.01em;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .skip-btn:hover{background:rgba(255,255,255,.18)} .skip-btn:focus-visible{outline:3px solid rgba(255,255,255,.5);outline-offset:2px}

    .row-inline{display:flex;gap:var(--sp-10);align-items:center;flex-wrap:nowrap} .row-inline>.input{flex:1;min-width:0} #addTag{white-space:nowrap;min-width:88px}
    .fab{border:none}
  </style>
</head>
<body>

  <div id="splash" class="splash" aria-hidden="true">
    <div class="splash-card">
      <span class="splash-bulb material-symbols-rounded ms-outline" aria-hidden="true">lightbulb</span>
      <div class="splash-logo">IDEA BRAIN</div>
      <div class="splash-sub">loading ideas</div>
      <button id="skipSplash" class="skip-btn" type="button" aria-label="Skip to main">Skip</button>
    </div>
  </div>

  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand">IDEA BRAIN</div>
        <div class="toolbar">
          <button class="icon-btn" id="themeBtn" title="테마 전환"><span class="material-symbols-rounded">contrast</span></button>
          <button class="icon-btn" id="calBtn" title="캘린더 보기"><span class="material-symbols-rounded">calendar_month</span></button>
          <button class="icon-btn" id="searchBtn" title="검색 (⌘/Ctrl+K)"><span class="material-symbols-rounded">search</span></button>
        </div>
      </div>
      <div class="search" id="searchBar">
        <input id="searchInput" type="text" placeholder="아이디어 검색… (제목·태그·내용)" autocomplete="off" />
        <div id="searchResults" class="search-results"></div>
      </div>
    </div>
  </header>

  <main>
    <div class="viewbar" id="viewBar">
      <button class="vbtn active" id="listBtn"><span class="material-symbols-rounded" style="font-size:18px">view_list</span>목록</button>
      <button class="vbtn" id="gridBtn"><span class="material-symbols-rounded" style="font-size:18px">grid_view</span>그리드</button>
    </div>

    <section id="ideas" class="list"></section>

    <section id="calendarWrap" style="display:none">
      <div class="cal-card">
        <div class="cal-head">
          <button class="cal-btn" id="prevMonth"><span class="material-symbols-rounded">chevron_left</span></button>
          <div class="cal-title" id="calTitle">YYYY.MM</div>
          <button class="cal-btn" id="nextMonth"><span class="material-symbols-rounded">chevron_right</span></button>
        </div>
        <div class="cal-grid" style="margin-bottom: var(--sp-8);">
          <div class="cal-dow" style="color:#ef4444">일</div><div class="cal-dow">월</div><div class="cal-dow">화</div><div class="cal-dow">수</div><div class="cal-dow">목</div><div class="cal-dow">금</div><div class="cal-dow" style="color:#3b82f6">토</div>
        </div>
        <div class="cal-grid" id="calDays"></div>
      </div>
    </section>

    <div id="empty" class="empty" style="display:none">
      <div class="ico material-symbols-rounded">lightbulb</div>
      <h3>아직 아이디어가 없습니다</h3>
      <div>오른쪽 아래 <b>+</b> 버튼으로 첫 아이디어를 추가해보세요</div>
    </div>
  </main>

  <button class="fab" id="fab" title="새 아이디어"><span class="material-symbols-rounded">add</span></button>

  <!-- Modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">새 아이디어</div>
        <button class="icon-btn" id="closeModal"><span class="material-symbols-rounded">close</span></button>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: var(--sp-14)">
          <label class="label">제목</label>
          <input id="title" class="input" type="text" placeholder="아이디어 제목" />
        </div>
        <div style="margin-bottom: var(--sp-14)">
          <label class="label">태그</label>
          <div id="tags" class="tags" style="margin-bottom: var(--sp-10)"></div>
          <div class="row-inline">
            <input id="tagInput" class="input" type="text" placeholder="태그 입력 후 Enter" />
            <button id="addTag" class="btn btn-primary"><span class="material-symbols-rounded">add</span>추가</button>
          </div>
        </div>
        <div style="margin-bottom: var(--sp-14)">
          <label class="label">이미지</label>
          <input id="imageInput" type="file" accept="image/*" style="display:none" />
          <button id="imagePick" class="drop" style="display:flex;align-items:center;justify-content:center;gap:var(--sp-10);height:120px">
            <span class="material-symbols-rounded">add_photo_alternate</span> 이미지 업로드
          </button>
          <div id="imagePreview" style="display:none;margin-top:var(--sp-12);position:relative;">
            <img id="previewImg" style="width:100%;border-radius:var(--r-lg)" />
            <button id="removeImage" class="icon-btn" style="position:absolute;top:var(--sp-12);right:var(--sp-12);background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff"><span class="material-symbols-rounded">close</span></button>
          </div>
        </div>
        <div style="margin-bottom: var(--sp-16)">
          <label class="label">내용</label>
          <div id="editor"></div>
        </div>
        <div style="display:flex;gap:var(--sp-10)">
          <button id="deleteBtn" class="btn btn-danger" style="display:none;flex:1"><span class="material-symbols-rounded">delete</span>삭제</button>
          <button id="saveBtn" class="btn btn-primary" style="flex:1"><span class="material-symbols-rounded">save</span>저장</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
  <script>
    // ===== State
    let quill; let editingId=null; let tags=[]; let imageData=null; let view='list'; let calDate=new Date();
    const $=s=>document.querySelector(s); const $$=s=>document.querySelectorAll(s); const ideasKey='ideas';

    function getIdeas(){ try{return JSON.parse(localStorage.getItem(ideasKey)||'[]')}catch{return[]} }
    function setIdeas(data){ localStorage.setItem(ideasKey, JSON.stringify(data)); }

    // Theme
    function loadTheme(){
      const t=localStorage.getItem('theme'); const html=document.documentElement; html.classList.remove('light','dark');
      if(!t){ const sysLight=window.matchMedia&&window.matchMedia('(prefers-color-scheme: light)').matches; html.classList.add(sysLight?'light':'dark'); html.dataset.theme=sysLight?'light':'dark'; }
      else { html.classList.add(t); html.dataset.theme=t; }
    }
    function toggleTheme(){
      const html=document.documentElement; const toLight=!html.classList.contains('light');
      html.classList.toggle('light',toLight); html.classList.toggle('dark',!toLight);
      const val=toLight?'light':'dark'; html.dataset.theme=val; localStorage.setItem('theme', val);
    }

    // List/Grid render
    function renderIdeas(list=getIdeas()){
      const wrap=$('#ideas'); const empty=$('#empty');
      if(list.length===0){ wrap.innerHTML=''; empty.style.display='block'; return; }
      empty.style.display='none'; wrap.className=(view==='grid')?'grid':'list'; wrap.innerHTML=list.map(card).join('');
    }
    function card(idea){
      const d=new Date(idea.createdAt||Date.now());
      const date=`${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
      const time=d.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});
      const preview=(idea.content||'').replace(/<[^>]*>/g,'').slice(0,110);
      return `<article class="card" onclick="openModal(${idea.id})" tabindex="0" aria-label="${idea.title||''}">
        ${idea.image?`<div class="thumb"><img src="${idea.image}" alt="" /></div>`:''}
        <h3 class="title">${idea.title||''}</h3>
        ${preview?`<p class="preview">${preview}${preview.length>=110?'…':''}</p>`:''}
        ${(idea.tags&&idea.tags.length)?`<div class="tags">${idea.tags.map(t=>`<span class=tag>${t}</span>`).join('')}</div>`:''}
        <div class="meta">
          <div style="display:flex;align-items:center;gap:.35rem"><span class="material-symbols-rounded" style="font-size:16px">calendar_today</span>${date}</div>
          <div style="display:flex;align-items:center;gap:.35rem"><span class="material-symbols-rounded" style="font-size:16px">schedule</span>${time}</div>
        </div>
      </article>`;
    }

    // Calendar
    function renderCalendar(){
      $('#calTitle').textContent=`${calDate.getFullYear()}.${String(calDate.getMonth()+1).padStart(2,'0')}`;
      const first=new Date(calDate.getFullYear(),calDate.getMonth(),1).getDay();
      const last=new Date(calDate.getFullYear(),calDate.getMonth()+1,0).getDate();
      const days=$('#calDays'); days.innerHTML='';
      for(let i=0;i<first;i++) days.innerHTML+=`<div></div>`;
      const set=new Set(getIdeas().map(i=>{const d=new Date(i.createdAt);return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`}));
      for(let day=1;day<=last;day++){ const key=`${calDate.getFullYear()}-${calDate.getMonth()}-${day}`;
        const today=new Date(); const isToday=today.toDateString()===new Date(calDate.getFullYear(),calDate.getMonth(),day).toDateString();
        days.innerHTML+=`<div class="cal-day ${set.has(key)?'has-idea':''}" style="${isToday?'box-shadow: 0 0 0 2px #6366f1':''}" onclick="filterByDate(${calDate.getFullYear()},${calDate.getMonth()},${day})">${day}</div>`;
      }
    }
    function filterByDate(y,m,d){
      const list=getIdeas().filter(i=>{const t=new Date(i.createdAt);return t.getFullYear()===y&&t.getMonth()===m&&t.getDate()===d});
      $('#calendarWrap').style.display='none'; $('#ideas').style.display=''; $('#viewBar').style.display=''; renderIdeas(list);
    }

    // Modal
    function openModal(id){
      editingId=id??null; $('#overlay').style.display='flex';
      $('#modalTitle').textContent=id?'아이디어 수정':'새 아이디어';
      if(id){ const i=getIdeas().find(x=>x.id===id); if(i){ $('#title').value=i.title||''; quill.root.innerHTML=i.content||''; tags=[...(i.tags||[])]; imageData=i.image||null; paintTags(); if(imageData){ showImage(imageData); $('#removeImage').style.display=''; } $('#deleteBtn').style.display='inline-flex'; } }
      else{ resetModal(); }
    }
    function closeModal(){ $('#overlay').style.display='none'; resetModal(); }
    function resetModal(){ editingId=null; $('#title').value=''; quill?.setText(''); tags=[]; imageData=null; paintTags(); hideImage(); $('#deleteBtn').style.display='none'; }

    // Tags
    function paintTags(){ $('#tags').innerHTML=tags.map(t=>`<span class="tag">${t}<button onclick="removeTag('${t}')" class="icon-btn" style="width:24px;height:24px;border-radius:8px"><span class="material-symbols-rounded" style="font-size:16px">close</span></button></span>`).join('') }
    function addTag(){ const v=$('#tagInput').value.trim(); if(v&&!tags.includes(v)){ tags.push(v); paintTags(); } $('#tagInput').value='' }
    function removeTag(t){ tags=tags.filter(x=>x!==t); paintTags() }

    // Image
    function showImage(src){ $('#imagePreview').style.display='block'; $('#previewImg').src=src }
    function hideImage(){ $('#imagePreview').style.display='none'; $('#previewImg').src='' }

    // Save/Delete
    function save(){
      const title=$('#title').value.trim(); if(!title) return alert('제목을 입력해주세요');
      const content=quill.root.innerHTML; const data=getIdeas(); const now=new Date().toISOString();
      if(editingId){ const idx=data.findIndex(i=>i.id===editingId); if(idx>-1){ const orig=data[idx]; data[idx]={...orig,title,content,tags:[...tags],image:imageData,updatedAt:now}; } }
      else{ data.unshift({id:Date.now(),title,content,tags:[...tags],image:imageData,createdAt:now,updatedAt:now}); }
      setIdeas(data); renderIdeas(); renderCalendar(); closeModal();
    }
    function remove(){ if(!confirm('정말 삭제하시겠습니까?')) return; const data=getIdeas().filter(i=>i.id!==editingId); setIdeas(data); renderIdeas(); renderCalendar(); closeModal(); }

    // Search (works even if content/tags missing)
    function doSearch(){
      const q=$('#searchInput').value.trim().toLowerCase();
      const data=getIdeas().filter(i=> (i.title||'').toLowerCase().includes(q) || (i.tags||[]).some(t=>(t||'').toLowerCase().includes(q)) || (i.content||'').toLowerCase().includes(q) );
      renderIdeas(data);
    }
    function highlight(text,q){
      if(!q) return text;
      const re=new RegExp('(' + q.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\\\$&') + ')','ig');
      return (text||'').replace(re,'<mark>$1</mark>');
    }
    function buildSearchResults(){
      const box=document.getElementById('searchResults');
      const q=document.getElementById('searchInput').value.trim().toLowerCase();
      const items=getIdeas().map(i=>({ id:i.id, title:i.title||'', tags:(i.tags||[]).join(', '), text:(i.content||'').replace(/<[^>]*>/g,'') }))
        .filter(i=> q && (i.title.toLowerCase().includes(q) || (i.tags||'').toLowerCase().includes(q) || i.text.toLowerCase().includes(q)) ).slice(0,8);
      if(!q){ box.style.display='none'; return; }
      if(items.length===0){ box.style.display='block'; box.innerHTML=`<div class="search-empty">검색 결과가 없습니다</div>`; return; }
      box.style.display='block';
      box.innerHTML=items.map(i=>`<div class="search-item" data-id="${i.id}"><span class="material-symbols-rounded" style="font-size:18px">note</span><div><div style="font-weight:800">${highlight(i.title,q)}</div><div style="font-size:12px;color:var(--muted)">${highlight(i.tags||'',q)}</div></div></div>`).join('');
      box.querySelectorAll('.search-item').forEach(el=> el.addEventListener('click', ()=>{ openModal(Number(el.dataset.id)); box.style.display='none'; }));
    }

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      // Splash controls
      let __splashHidden=false;
      const hideSplash=()=>{ if(__splashHidden) return; const s=document.getElementById('splash'); if(!s) return; __splashHidden=true; s.classList.add('hide'); setTimeout(()=>s.remove(),520); };

      loadTheme();
      $('#themeBtn').addEventListener('click', toggleTheme);

      quill=new Quill('#editor',{ theme:'snow', placeholder:'아이디어를 자유롭게 작성하세요…',
        modules:{ toolbar:[[{header:[1,2,3,false]}],['bold','italic','underline','strike'],[{list:'ordered'},{list:'bullet'}],[{color:[]},{align:[]}],['link','image'],['clean']] } });

      renderIdeas(); renderCalendar();

      // Splash auto + click + skip
      setTimeout(hideSplash,3000);
      const __s=document.getElementById('splash'); if(__s) __s.addEventListener('click', hideSplash);
      const __sk=document.getElementById('skipSplash'); if(__sk) __sk.addEventListener('click', hideSplash);

      // View toggles
      $('#listBtn').addEventListener('click', ()=>{ view='list'; $('#listBtn').classList.add('active'); $('#gridBtn').classList.remove('active'); renderIdeas(); });
      $('#gridBtn').addEventListener('click', ()=>{ view='grid'; $('#gridBtn').classList.add('active'); $('#listBtn').classList.remove('active'); renderIdeas(); });

      // Calendar toggle
      $('#calBtn').addEventListener('click', ()=>{
        const cal=$('#calendarWrap'); const ideas=$('#ideas'); const vb=$('#viewBar'); const showCal=cal.style.display==='none';
        cal.style.display=showCal?'':'none'; ideas.style.display=showCal?'none':''; vb.style.display=showCal?'none':'';
        if(showCal) renderCalendar(); else renderIdeas();
      });
      $('#prevMonth').addEventListener('click', ()=>{ calDate.setMonth(calDate.getMonth()-1); renderCalendar(); });
      $('#nextMonth').addEventListener('click', ()=>{ calDate.setMonth(calDate.getMonth()+1); renderCalendar(); });

      // Search UX
      $('#searchBtn').addEventListener('click', ()=>{
        const sb=$('#searchBar'); const showing=getComputedStyle(sb).display!=='none';
        sb.style.display=showing?'none':''; if(!showing){ $('#searchInput').focus(); buildSearchResults(); } else { $('#searchInput').value=''; $('#searchResults').style.display='none'; renderIdeas(); }
      });
      $('#searchInput').addEventListener('input', ()=>{ doSearch(); buildSearchResults(); });
      document.addEventListener('click', (e)=>{ const sb=$('#searchBar'); if(sb && !sb.contains(e.target)) $('#searchResults').style.display='none'; });

      document.addEventListener('keydown', (e)=>{
        const k=(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k';
        const slash=e.key==='/'&&!e.metaKey&&!e.ctrlKey&&!e.shiftKey;
        if(k){ e.preventDefault(); $('#searchBar').style.display=''; $('#searchInput').focus(); }
        if(slash){ e.preventDefault(); openModal(); }
        if(e.key==='Escape'){ if($('#overlay').style.display==='flex') closeModal(); }
      });

      // Modal + image
      $('#fab').addEventListener('click', ()=>openModal());
      $('#closeModal').addEventListener('click', closeModal);
      $('#saveBtn').addEventListener('click', save);
      $('#deleteBtn').addEventListener('click', remove);
      $('#addTag').addEventListener('click', addTag);
      $('#tagInput').addEventListener('keypress', e=>{ if(e.key==='Enter'){ e.preventDefault(); addTag(); }});
      $('#imagePick').addEventListener('click', ()=> $('#imageInput').click());
      $('#removeImage').addEventListener('click', ()=>{ imageData=null; hideImage(); });
      $('#imageInput').addEventListener('change', e=>{
        const f=e.target.files?.[0]; if(!f) return; if(f.size>5*1024*1024){ alert('이미지 크기는 5MB 이하여야 합니다.'); return; }
        const reader=new FileReader(); reader.onload=ev=>{ imageData=ev.target.result; showImage(imageData); }; reader.onerror=()=>alert('이미지를 읽는 중 오류가 발생했습니다.'); reader.readAsDataURL(f);
      });
    });

    // expose
    window.openModal=openModal; window.filterByDate=filterByDate;
  </script>
</body>
</html>
